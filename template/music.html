<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/ant-design-vue@1.7.8/dist/antd.min.css" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" />
    <script src="//cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="//cdn.jsdelivr.net/npm/ant-design-vue@1.7.8/dist/antd.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/axios@1.3.4/dist/axios.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
    <style>
      #app {
        padding: 20px 20px 0px 20px;
      }
      .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .anticon-left,
      .anticon-right {
        margin-top: 30%;
      }
      .ant-input-group-compact {
        text-align: right;
      }
      .anticon-caret-right {
        font-size: 18px;
        padding-left: 8%;
      }
      #aplayer {
        position: absolute;
        width: 99.5%;
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div>
      <div id="app">
        <div class="top">
          <a-button
            style="padding: 0 10px"
            type="primary"
            :disabled="!selectedRowKeys.length"
            :loading="downLoading"
            @click="onDownload"
          >
            {{downLoading ? "下载ing" : "下载"}}
          </a-button>
          <div>
            <a-input-group compact>
              <a-select
                v-model="params.service"
                :options="services"
                @change="onParamsChange"
              ></a-select>
              <a-input-search
                v-model="params.text"
                placeholder="搜索"
                style="width: 58%; text-align: left"
                enter-button
                @search="onParamsChange"
              ></a-input-search>
            </a-input-group>
          </div>
        </div>
        <a-table
          bordered
          :loading="loading"
          :row-selection="rowSelection"
          :scroll="{ y: scrollHeight }"
          :columns="columns"
          :data-source="dataSource"
          :pagination="pagination"
          @change="onParamsChange"
          :row-key="({songName, url, disabled, index}) => disabled ? index : `${songName}+${url}`"
        >
          <template slot="action" slot-scope="text, record">
            <a-button
              :disabled="record.disabled"
              type="primary"
              shape="circle"
              icon="caret-right"
              @click="onButtonClick(record)"
            />
          </template>
        </a-table>
      </div>
      <div id="aplayer"></div>
    </div>
    <script>
      Vue.use(antd)
      new Vue({
        data() {
          return {
            dataSource: [],
            loading: false,
            downLoading: false,
            scrollHeight: window.innerHeight - 280,
            services: [
              {
                label: '咪咕',
                value: 'migu',
              },
              {
                label: '酷我',
                value: 'kuwo',
              },
              {
                label: '网易',
                value: 'wangyi',
              },
              {
                label: '酷狗',
                value: 'kugou',
              },
            ],
            params: {
              service: 'migu',
              pageNum: 1,
              text: '',
            },
            columns: [
              {
                title: '歌曲名称',
                dataIndex: 'name',
                width: '75%',
              },
              {
                title: '播放',
                dataIndex: 'action',
                scopedSlots: {
                  customRender: 'action',
                },
                width: '25%',
              },
            ],
            pagination: {
              current: 1,
              pageSize: 20,
              showLessItems: true,
              total: 0,
            },
            selectedRowKeys: [],
            player: null,
          }
        },
        beforeDestroy() {
          this.player.destroy()
        },
        created() {
          this.player = new APlayer({
            container: document.getElementById('aplayer'),
            listMaxHeight: 450,
            listFolded: true,
            lrcType: 1,
            audio: [],
          })
        },
        computed: {
          rowSelection() {
            return {
              selectedRowKeys: this.selectedRowKeys,
              onChange: (selectedRowKeys) => {
                this.selectedRowKeys = selectedRowKeys
              },
              getCheckboxProps: (record) => ({
                props: {
                  disabled: record.disabled,
                },
              }),
            }
          },
        },
        methods: {
          async getDataSource() {
            this.loading = true
            this.player.list.clear()
            this.selectedRowKeys = []
            const { service } = this.params
            const res = await axios
              .get('/search', {
                params: this.params,
              })
              .finally(() => (this.loading = false))
            const { searchSongs, totalSongCount } = res.data
            const list = searchSongs
              .filter(({ disabled }) => !disabled)
              .map(
                ({ id, DC_TARGETID, hash, songName, url, imgItems, hts_MVPIC, artists, lrc }) => {
                  const name = songName.split(' - ')[1].split('.')[0]
                  const artist = songName.split(' - ')[0]
                  return {
                    name,
                    artist,
                    lrc,
                    url,
                    id: service === 'kuwo' ? DC_TARGETID : service === 'kugou' ? hash : id,
                    cover:
                      service === 'migu'
                        ? imgItems[0]?.img
                        : service === 'kuwo'
                        ? hts_MVPIC
                        : service === 'wangyi'
                        ? artists[0]?.img1v1Url
                        : '',
                  }
                }
              )
            this.dataSource = searchSongs.map((song) => {
              song.name = `${song.songName.split(' - ')[1].split('.')[0]} - ${
                song.songName.split(' - ')[0]
              }`
              return song
            })
            this.pagination.total = ~~totalSongCount
            this.player.list.add(list)
          },
          onParamsChange({ current }) {
            this.params.pageNum = current ?? 1
            this.pagination.current = current ?? 1
            this.getDataSource()
          },
          onButtonClick({ id: songId, DC_TARGETID, hash }) {
            const index = this.player.list.audios.findIndex(
              ({ id }) => id === (songId ?? DC_TARGETID ?? hash)
            )
            this.player.list.switch(index)
            this.player.play()
          },
          onDownload() {
            this.downLoading = true
            Promise.all(
              this.selectedRowKeys.map(async (key) => {
                const [songName, url] = key.split('+')
                const { data } = await axios.get(`/download?url=${url}`, {
                  responseType: 'blob',
                })
                saveAs(data, songName)
              })
            ).finally(() => (this.downLoading = false))
          },
        },
      }).$mount('#app')
    </script>
  </body>
</html>
